# åˆåˆ›å›¢é˜Ÿ CI/CD é…ç½®
name: Startup Fast CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # å¿«é€Ÿæ£€æŸ¥ï¼ˆ2-3åˆ†é’Ÿå†…å®Œæˆï¼‰
  quick-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    # å¹¶è¡Œæ‰§è¡Œå¤šä¸ªæ£€æŸ¥
    - name: Lint & Type Check
      run: |
        # åªæ£€æŸ¥å˜æ›´çš„æ–‡ä»¶ï¼Œä¸æ˜¯å…¨é‡æ£€æŸ¥
        git diff --name-only HEAD~1 | grep -E '\.(py|ts|tsx)$' | xargs pylint
        
    - name: Unit Tests (Changed Files Only)
      run: |
        # åªæµ‹è¯•ç›¸å…³çš„æµ‹è¯•æ–‡ä»¶
        pytest --testmon --testmon-off
        
    - name: Security Scan (Fast)
      run: |
        # å¿«é€Ÿå®‰å…¨æ‰«æï¼Œä¸é˜»å¡éƒ¨ç½²
        bandit -r . -f json -o security-report.json || true

  # è‡ªåŠ¨éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  auto-deploy-dev:
    needs: quick-check
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to Dev
      run: |
        # è“ç»¿éƒ¨ç½²ï¼Œé›¶åœæœº
        ./scripts/deploy-dev.sh
        
    - name: Smoke Test
      run: |
        # åŸºæœ¬åŠŸèƒ½æµ‹è¯•
        curl -f https://dev.flopap.com/health || exit 1
        
    - name: Notify Team
      run: |
        # Slack é€šçŸ¥
        curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"ğŸš€ Dev deployed: '"$GITHUB_SHA"'"}' \
          $SLACK_WEBHOOK

  # ç”Ÿäº§éƒ¨ç½²ï¼ˆéœ€è¦æ‰‹åŠ¨è§¦å‘ï¼‰
  deploy-prod:
    needs: auto-deploy-dev
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to Production
      run: ./scripts/deploy-prod.sh
